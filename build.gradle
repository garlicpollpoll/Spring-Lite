plugins {
    id 'java'
    id 'application'
}

group = 'com.springlite'
version = '1.0.0'
sourceCompatibility = '11'

repositories {
    mavenCentral()
}

dependencies {
    // Jetty 서버 의존성들
    implementation 'org.eclipse.jetty:jetty-server:9.4.44.v20210927'
    implementation 'org.eclipse.jetty:jetty-servlet:9.4.44.v20210927'
    implementation 'org.eclipse.jetty:jetty-webapp:9.4.44.v20210927'
    implementation 'org.eclipse.jetty:jetty-annotations:9.4.44.v20210927'
    
    // 🔥 JSP 지원 의존성들 (Apache JSP 엔진 사용)
    implementation 'org.eclipse.jetty:apache-jsp:9.4.44.v20210927'
    implementation 'org.eclipse.jetty:apache-jstl:9.4.44.v20210927'
    
    // JSP API 및 EL (Expression Language)
    implementation 'javax.servlet.jsp:javax.servlet.jsp-api:2.3.3'
    implementation 'javax.el:javax.el-api:3.0.0'
    implementation 'org.glassfish:javax.el:3.0.0'
    
    // Servlet API
    implementation 'javax.servlet:javax.servlet-api:4.0.1'
    
    // Jackson for JSON processing
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.15.2'
    
    // 🔥 H2 데이터베이스 (JDBC 테스트용)
    implementation 'com.h2database:h2:2.2.224'
    
    // 로깅 (선택사항)
    implementation 'org.slf4j:slf4j-simple:1.7.36'
}

application {
    mainClass = 'com.springlite.demo.Application'
}

// 🔥 JSP 컴파일을 위한 추가 설정
compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-parameters']
}

// 실행 시 JVM 옵션 설정
run {
    systemProperty 'file.encoding', 'UTF-8'
    jvmArgs = [
        '-Dorg.eclipse.jetty.util.log.class=org.eclipse.jetty.util.log.StdErrLog',
        '-Dorg.eclipse.jetty.LEVEL=INFO'
    ]
}

// JAR 빌드 설정
jar {
    manifest {
        attributes(
            'Main-Class': 'com.springlite.demo.Application'
        )
    }
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// 🔥 JDBC 테스트 애플리케이션 실행 태스크
task runJdbcTest(type: JavaExec) {
    description = 'Run JDBC Test Application'
    group = 'application'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.springlite.demo.JdbcTestApp'
    systemProperty 'file.encoding', 'UTF-8'
    jvmArgs = [
        '-Dorg.eclipse.jetty.util.log.class=org.eclipse.jetty.util.log.StdErrLog',
        '-Dorg.eclipse.jetty.LEVEL=INFO'
    ]
}

// 🔥 AOP 테스트 애플리케이션 실행 태스크
task runAopTest(type: JavaExec) {
    description = 'Run AOP Test Application'
    group = 'application'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.springlite.demo.AopTestApp'
    systemProperty 'file.encoding', 'UTF-8'
    jvmArgs = [
        '-Dorg.eclipse.jetty.util.log.class=org.eclipse.jetty.util.log.StdErrLog',
        '-Dorg.eclipse.jetty.LEVEL=INFO'
    ]
}

task runLifecycleTest(type: JavaExec) {
    description = 'Run Lifecycle Test Application'
    group = 'application'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.springlite.demo.LifecycleTestApp'
    systemProperty 'file.encoding', 'UTF-8'
    jvmArgs = [
        '-Dorg.eclipse.jetty.util.log.class=org.eclipse.jetty.util.log.StdErrLog',
        '-Dorg.eclipse.jetty.LEVEL=INFO'
    ]
}

task printClasspath {
    doLast {
        configurations.runtimeClasspath.each { println it }
    }
}

// 트랜잭션 테스트 실행 태스크
task runTransactionTest(type: JavaExec) {
    group = 'application'
    description = '🔄 Spring Lite 트랜잭션 시스템 테스트 실행'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.springlite.demo.TransactionTestApp'
    
    doFirst {
        println '🔄 Spring Lite 트랜잭션 ACID 테스트를 시작합니다!'
        println '==================================================='
    }
} 